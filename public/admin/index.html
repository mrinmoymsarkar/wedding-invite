<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Wedding Content Manager</title>
  <link rel="icon" type="image/png" href="https://1fimd9lwq61lrowk.public.blob.vercel-storage.com/wediing-icon-MWGi3zHWRSwveW4CaK9EM7s57pDP54.png" />
  
  <!-- Netlify Identity Widget -->
  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
  
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      margin: 0;
      padding: 20px;
      background: linear-gradient(135deg, #FFF8DC 0%, #FFFFF0 100%);
      min-height: 100vh;
    }
    
    .setup-container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      padding: 30px;
      box-shadow: 0 10px 40px rgba(220, 20, 60, 0.15);
      text-align: center;
    }
    
    .logo {
      width: 60px;
      height: 60px;
      margin: 0 auto 20px;
    }
    
    .title {
      color: #8B0000;
      font-size: 28px;
      font-weight: 600;
      margin-bottom: 10px;
    }
    
    .subtitle {
      color: #666;
      font-size: 16px;
      margin-bottom: 30px;
    }
    
    .status {
      padding: 15px;
      border-radius: 8px;
      margin: 20px 0;
      text-align: left;
    }
    
    .info { background: #d1ecf1; border: 1px solid #bee5eb; color: #0c5460; }
    .warning { background: #fff3cd; border: 1px solid #ffeaa7; color: #856404; }
    .error { background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
    .success { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
    
    .button {
      display: inline-block;
      padding: 12px 24px;
      background: linear-gradient(135deg, #DC143C, #8B0000);
      color: white;
      text-decoration: none;
      border-radius: 8px;
      margin: 10px;
      font-weight: 500;
      transition: transform 0.2s;
      border: none;
      cursor: pointer;
      font-size: 14px;
    }
    
    .button:hover {
      transform: translateY(-2px);
    }
    
    .button.secondary {
      background: linear-gradient(135deg, #FFD700, #FFC107);
      color: #333;
    }
    
    .button.success {
      background: linear-gradient(135deg, #28a745, #20c997);
      color: white;
    }
    
    .steps {
      text-align: left;
      margin: 30px 0;
    }
    
    .step {
      padding: 20px;
      margin: 15px 0;
      background: #f8f9fa;
      border-left: 4px solid #DC143C;
      border-radius: 0 8px 8px 0;
    }
    
    .step h4 {
      margin: 0 0 10px 0;
      color: #8B0000;
    }
    
    .code {
      background: #f1f3f4;
      padding: 2px 6px;
      border-radius: 4px;
      font-family: 'Monaco', 'Consolas', monospace;
      font-size: 14px;
    }
    
    .auth-section {
      background: #e7f3ff;
      border: 2px solid #007bff;
      border-radius: 10px;
      padding: 25px;
      margin: 25px 0;
    }
    
    .auth-section h3 {
      color: #004085;
      margin-top: 0;
    }
    
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #DC143C;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .hidden {
      display: none;
    }
    
    .user-info {
      background: #d4edda;
      border: 1px solid #c3e6cb;
      color: #155724;
      padding: 15px;
      border-radius: 8px;
      margin: 15px 0;
    }
    
    .cms-ready {
      background: linear-gradient(135deg, #28a745, #20c997);
      color: white;
      padding: 20px;
      border-radius: 10px;
      margin: 20px 0;
    }
    
    .cms-ready h3 {
      margin-top: 0;
      color: white;
    }
    
    .setup-instructions {
      background: #fff3cd;
      border: 1px solid #ffeaa7;
      color: #856404;
      padding: 20px;
      border-radius: 8px;
      margin: 20px 0;
      text-align: left;
    }
    
    .setup-instructions h4 {
      margin-top: 0;
      color: #856404;
    }
    
    .setup-instructions ol {
      margin: 10px 0;
      padding-left: 20px;
    }
    
    .setup-instructions li {
      margin: 8px 0;
    }
  </style>
</head>
<body>
  <div class="setup-container">
    <img src="https://1fimd9lwq61lrowk.public.blob.vercel-storage.com/wediing-icon-MWGi3zHWRSwveW4CaK9EM7s57pDP54.png" alt="Wedding Icon" class="logo" />
    
    <h1 class="title">Wedding Content Manager</h1>
    <p class="subtitle">Manage your wedding website content with ease</p>
    
    <div id="auth-status"></div>
    
    <!-- Authentication Section -->
    <div class="auth-section">
      <h3>üîê Authentication Setup</h3>
      <p>This CMS uses Netlify Identity for secure authentication. Follow the setup below:</p>
      
      <div id="setup-instructions" class="setup-instructions">
        <h4>üìã Setup Instructions:</h4>
        <ol>
          <li><strong>Enable Netlify Identity:</strong>
            <br>Go to <a href="https://app.netlify.com/sites/neon-meerkat-c50769/settings/identity" target="_blank">Netlify Identity Settings</a>
            <br>Click "Enable Identity" if not already enabled
          </li>
          
          <li><strong>Enable Git Gateway:</strong>
            <br>In the same page, scroll to "Services" section
            <br>Click "Enable Git Gateway"
          </li>
          
          <li><strong>Configure Registration:</strong>
            <br>Set "Registration preferences" to "Open" or "Invite only"
            <br>If using "Invite only", you'll need to invite users manually
          </li>
          
          <li><strong>Add Users:</strong>
            <br>Go to <a href="https://app.netlify.com/sites/neon-meerkat-c50769/identity" target="_blank">Identity Users</a>
            <br>Click "Invite users" and add email addresses
            <br>Or set registration to "Open" to allow self-registration
          </li>
        </ol>
        
        <div class="warning status">
          <strong>‚ö†Ô∏è Important:</strong> Make sure Git Gateway is enabled for the CMS to work properly!
        </div>
      </div>
      
      <div id="auth-controls">
        <button onclick="openLogin()" class="button">Login / Sign Up</button>
        <button onclick="clearAuthData()" class="button secondary">Clear Auth Data</button>
        <button onclick="checkAuthStatus()" class="button secondary">Check Status</button>
      </div>
    </div>
    
    <!-- User Info Section (hidden by default) -->
    <div id="user-info" class="user-info hidden">
      <h4>üë§ Logged in as: <span id="user-email"></span></h4>
      <p>You can now access the Content Management System!</p>
      <button onclick="logout()" class="button secondary">Logout</button>
    </div>
    
    <!-- CMS Ready Section (hidden by default) -->
    <div id="cms-ready" class="cms-ready hidden">
      <h3>üéâ CMS Ready!</h3>
      <p>You are authenticated and ready to edit content.</p>
      <button onclick="initializeCMS()" class="button" style="background: white; color: #28a745;">
        Launch Content Editor
      </button>
    </div>
    
    <!-- Debug Section -->
    <div style="margin-top: 30px;">
      <details>
        <summary style="cursor: pointer; color: #666;">üîß Debug Information</summary>
        <div style="margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px; text-align: left;">
          <h4>Configuration Status:</h4>
          <div id="debug-info">
            <p>Loading debug information...</p>
          </div>
        </div>
      </details>
    </div>
    
    <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #eee; color: #666; font-size: 14px;">
      <p><strong>Alternative:</strong> If the CMS doesn't work, you can edit files directly in the <span class="code">src/config/</span> directory.</p>
      <a href="https://app.netlify.com/sites/neon-meerkat-c50769/settings/identity" target="_blank" class="button secondary">
        Open Netlify Settings
      </a>
    </div>
  </div>

  <!-- Include Decap CMS -->
  <script src="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js"></script>
  
  <!-- Enhanced Authentication Script -->
  <script>
    const statusDiv = document.getElementById('auth-status');
    const userInfoDiv = document.getElementById('user-info');
    const cmsReadyDiv = document.getElementById('cms-ready');
    const setupInstructionsDiv = document.getElementById('setup-instructions');
    const authControlsDiv = document.getElementById('auth-controls');
    
    let currentUser = null;
    let cmsInitialized = false;
    
    function updateStatus(message, type = 'info') {
      statusDiv.innerHTML = `<div class="${type} status">${message}</div>`;
    }
    
    function updateDebugInfo() {
      const debugDiv = document.getElementById('debug-info');
      const info = {
        'Netlify Identity Available': !!window.netlifyIdentity,
        'Current User': currentUser ? currentUser.email : 'None',
        'User Token': currentUser ? 'Available' : 'None',
        'Site URL': window.location.origin,
        'Identity URL': window.netlifyIdentity ? window.netlifyIdentity.url : 'Not available',
        'CMS Initialized': cmsInitialized
      };
      
      debugDiv.innerHTML = Object.entries(info)
        .map(([key, value]) => `<strong>${key}:</strong> ${value}`)
        .join('<br>');
    }
    
    function showUserInfo(user) {
      document.getElementById('user-email').textContent = user.email;
      userInfoDiv.classList.remove('hidden');
      cmsReadyDiv.classList.remove('hidden');
      setupInstructionsDiv.style.display = 'none';
      authControlsDiv.style.display = 'none';
    }
    
    function hideUserInfo() {
      userInfoDiv.classList.add('hidden');
      cmsReadyDiv.classList.add('hidden');
      setupInstructionsDiv.style.display = 'block';
      authControlsDiv.style.display = 'block';
    }
    
    function openLogin() {
      if (window.netlifyIdentity) {
        updateStatus('üîÑ Opening login dialog...', 'info');
        window.netlifyIdentity.open();
      } else {
        updateStatus('‚ùå Netlify Identity not available. Please check setup.', 'error');
      }
    }
    
    function logout() {
      if (window.netlifyIdentity && currentUser) {
        window.netlifyIdentity.logout();
      }
    }
    
    function clearAuthData() {
      // Clear localStorage
      Object.keys(localStorage).forEach(key => {
        if (key.includes('gotrue') || key.includes('netlify') || key.includes('cms')) {
          localStorage.removeItem(key);
        }
      });
      
      // Clear sessionStorage
      sessionStorage.clear();
      
      updateStatus('‚úÖ Authentication data cleared! Try logging in again.', 'success');
      
      // Remove any tokens from URL
      if (window.location.hash) {
        window.location.hash = '';
      }
      
      // Refresh the page to reset state
      setTimeout(() => {
        window.location.reload();
      }, 2000);
    }
    
    function checkAuthStatus() {
      if (window.netlifyIdentity) {
        const user = window.netlifyIdentity.currentUser();
        if (user) {
          updateStatus(`‚úÖ Authenticated as: ${user.email}`, 'success');
          currentUser = user;
          showUserInfo(user);
        } else {
          updateStatus('‚ÑπÔ∏è Not authenticated. Please log in.', 'info');
          hideUserInfo();
        }
      } else {
        updateStatus('‚ùå Netlify Identity not available', 'error');
      }
      updateDebugInfo();
    }
    
    function initializeCMS() {
      if (currentUser && window.CMS) {
        updateStatus('üöÄ Initializing Content Management System...', 'info');
        
        try {
          // Hide the setup container and show CMS
          document.querySelector('.setup-container').style.display = 'none';
          
          // Initialize CMS
          window.CMS.init();
          cmsInitialized = true;
          
          updateStatus('‚úÖ CMS initialized successfully!', 'success');
        } catch (error) {
          console.error('CMS initialization error:', error);
          updateStatus(`‚ùå CMS initialization failed: ${error.message}`, 'error');
          document.querySelector('.setup-container').style.display = 'block';
        }
      } else {
        updateStatus('‚ùå Cannot initialize CMS. Please ensure you are logged in.', 'error');
      }
    }
    
    // Initialize Netlify Identity
    if (window.netlifyIdentity) {
      updateStatus('üîÑ Initializing authentication system...', 'info');
      
      // Configure Netlify Identity
      window.netlifyIdentity.init({
        APIUrl: `${window.location.origin}/.netlify/identity`
      });
      
      // Set up event listeners
      window.netlifyIdentity.on('init', user => {
        console.log('Identity initialized:', user);
        currentUser = user;
        
        if (user) {
          updateStatus('‚úÖ Already logged in! Ready to use CMS.', 'success');
          showUserInfo(user);
        } else {
          updateStatus('üëã Please log in to access the Content Management System.', 'info');
          hideUserInfo();
        }
        updateDebugInfo();
      });
      
      window.netlifyIdentity.on('login', user => {
        console.log('User logged in:', user);
        currentUser = user;
        updateStatus('‚úÖ Login successful! You can now access the CMS.', 'success');
        showUserInfo(user);
        updateDebugInfo();
      });
      
      window.netlifyIdentity.on('logout', () => {
        console.log('User logged out');
        currentUser = null;
        updateStatus('üëã You have been logged out.', 'info');
        hideUserInfo();
        updateDebugInfo();
        
        // Show setup container if CMS was initialized
        if (cmsInitialized) {
          document.querySelector('.setup-container').style.display = 'block';
          cmsInitialized = false;
        }
      });
      
      window.netlifyIdentity.on('error', err => {
        console.error('Identity error:', err);
        
        let errorMessage = 'Authentication error occurred.';
        
        if (err.message) {
          if (err.message.includes('Email not confirmed')) {
            errorMessage = 'Email not confirmed. Please check your email or contact the administrator.';
          } else if (err.message.includes('Invalid email or password')) {
            errorMessage = 'Invalid email or password. Please try again.';
          } else if (err.message.includes('Failed to fetch')) {
            errorMessage = 'Network error. Please check your connection and try again.';
          } else if (err.message.includes('User not found')) {
            errorMessage = 'User not found. Please sign up or contact the administrator.';
          } else {
            errorMessage = err.message;
          }
        }
        
        updateStatus(`‚ùå ${errorMessage}`, 'error');
        updateDebugInfo();
      });
      
      window.netlifyIdentity.on('open', () => {
        console.log('Identity widget opened');
      });
      
      window.netlifyIdentity.on('close', () => {
        console.log('Identity widget closed');
      });
      
    } else {
      updateStatus('‚ùå Netlify Identity Widget not loaded. Please check your internet connection.', 'error');
    }
    
    // Auto-check status on page load
    setTimeout(() => {
      checkAuthStatus();
    }, 1000);
    
    // Test configuration access
    setTimeout(async () => {
      try {
        const response = await fetch('/admin/config.yml');
        if (response.ok) {
          console.log('‚úÖ CMS configuration accessible');
        } else {
          console.warn('‚ö†Ô∏è CMS configuration not accessible:', response.status);
        }
      } catch (error) {
        console.error('‚ùå Error accessing CMS configuration:', error);
      }
    }, 2000);
  </script>
</body>
</html>