<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Wedding Content Manager</title>
  <link rel="icon" type="image/png" href="https://1fimd9lwq61lrowk.public.blob.vercel-storage.com/wediing-icon-MWGi3zHWRSwveW4CaK9EM7s57pDP54.png" />
  
  <!-- Netlify Identity Widget -->
  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
  
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      margin: 0;
      padding: 20px;
      background: linear-gradient(135deg, #FFF8DC 0%, #FFFFF0 100%);
      min-height: 100vh;
    }
    
    .setup-container {
      max-width: 700px;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      padding: 30px;
      box-shadow: 0 10px 40px rgba(220, 20, 60, 0.15);
      text-align: center;
    }
    
    .logo {
      width: 60px;
      height: 60px;
      margin: 0 auto 20px;
    }
    
    .title {
      color: #8B0000;
      font-size: 28px;
      font-weight: 600;
      margin-bottom: 10px;
    }
    
    .subtitle {
      color: #666;
      font-size: 16px;
      margin-bottom: 30px;
    }
    
    .status {
      padding: 15px;
      border-radius: 8px;
      margin: 20px 0;
      text-align: left;
    }
    
    .info { background: #d1ecf1; border: 1px solid #bee5eb; color: #0c5460; }
    .warning { background: #fff3cd; border: 1px solid #ffeaa7; color: #856404; }
    .error { background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
    .success { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
    
    .button {
      display: inline-block;
      padding: 12px 24px;
      background: linear-gradient(135deg, #DC143C, #8B0000);
      color: white;
      text-decoration: none;
      border-radius: 8px;
      margin: 10px;
      font-weight: 500;
      transition: transform 0.2s;
      border: none;
      cursor: pointer;
    }
    
    .button:hover {
      transform: translateY(-2px);
    }
    
    .button.secondary {
      background: linear-gradient(135deg, #FFD700, #FFC107);
      color: #333;
    }
    
    .button.success {
      background: linear-gradient(135deg, #28a745, #20c997);
      color: white;
    }
    
    .steps {
      text-align: left;
      margin: 30px 0;
    }
    
    .step {
      padding: 15px;
      margin: 10px 0;
      background: #f8f9fa;
      border-left: 4px solid #DC143C;
      border-radius: 0 8px 8px 0;
    }
    
    .step h4 {
      margin: 0 0 10px 0;
      color: #8B0000;
    }
    
    .code {
      background: #f1f3f4;
      padding: 2px 6px;
      border-radius: 4px;
      font-family: 'Monaco', 'Consolas', monospace;
      font-size: 14px;
    }
    
    #netlify-identity-widget {
      margin: 20px 0;
    }
    
    .config-fix {
      background: #e7f3ff;
      border: 2px solid #007bff;
      border-radius: 10px;
      padding: 20px;
      margin: 20px 0;
    }
    
    .config-fix h3 {
      color: #004085;
      margin-top: 0;
    }
    
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #DC143C;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="setup-container">
    <img src="https://1fimd9lwq61lrowk.public.blob.vercel-storage.com/wediing-icon-MWGi3zHWRSwveW4CaK9EM7s57pDP54.png" alt="Wedding Icon" class="logo" />
    
    <h1 class="title">Wedding Content Manager</h1>
    <p class="subtitle">Manage your wedding website content easily</p>
    
    <div id="identity-status"></div>
    
    <!-- Configuration Fix Section -->
    <div class="config-fix">
      <h3>üîß Configuration Issue Detected</h3>
      <p><strong>Error:</strong> "Failed to load config.yml (Failed to fetch)"</p>
      <p><strong>Solution:</strong> This is usually caused by authentication or file access issues.</p>
      
      <div class="steps">
        <div class="step">
          <h4>Step 1: Enable Git Gateway</h4>
          <p>Go to your Netlify site settings and enable Git Gateway:</p>
          <ol>
            <li>Open <a href="https://app.netlify.com/sites/neon-meerkat-c50769/settings/identity" target="_blank">Netlify Identity Settings</a></li>
            <li>Scroll down to <strong>"Services"</strong></li>
            <li>Click <strong>"Enable Git Gateway"</strong></li>
            <li>Save the settings</li>
          </ol>
        </div>
        
        <div class="step">
          <h4>Step 2: Create User Account</h4>
          <p>Create a user account that can access the CMS:</p>
          <ol>
            <li>Go to <a href="https://app.netlify.com/sites/neon-meerkat-c50769/identity" target="_blank">Netlify Identity Users</a></li>
            <li>Click <strong>"Add user"</strong> (not "Invite users")</li>
            <li>Enter your email and set a password</li>
            <li>Make sure <strong>"Email confirmed"</strong> is checked</li>
            <li>Click "Add user"</li>
          </ol>
        </div>
        
        <div class="step">
          <h4>Step 3: Test Login</h4>
          <p>Return here and try logging in with your new credentials.</p>
        </div>
      </div>
      
      <a href="https://app.netlify.com/sites/neon-meerkat-c50769/settings/identity" target="_blank" class="button success">
        Open Netlify Settings
      </a>
    </div>
    
    <div id="netlify-identity-widget"></div>
    
    <div class="warning status">
      <strong>‚ö†Ô∏è Current Status:</strong>
      <br>‚Ä¢ CMS files are deployed ‚úÖ
      <br>‚Ä¢ Configuration file exists ‚úÖ
      <br>‚Ä¢ Issue: Authentication/access problem ‚ùå
      <br>‚Ä¢ Solution: Enable Git Gateway and create user ‚úÖ
    </div>
    
    <div style="margin-top: 30px;">
      <button onclick="testCMSAccess()" class="button">
        Test CMS Access
      </button>
      <button onclick="window.netlifyIdentity.open()" class="button secondary">
        Try Login
      </button>
    </div>
    
    <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #eee; color: #666; font-size: 14px;">
      <p><strong>Alternative:</strong> If you prefer to edit files directly, you can modify the configuration files in the <span class="code">src/config/</span> directory.</p>
    </div>
  </div>

  <!-- Include the script that builds the page and powers Decap CMS -->
  <script src="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js"></script>
  
  <!-- Enhanced Netlify Identity integration -->
  <script>
    const statusDiv = document.getElementById('identity-status');
    
    function updateStatus(message, type = 'info') {
      statusDiv.innerHTML = `<div class="${type} status">${message}</div>`;
    }
    
    // Test CMS configuration access
    async function testCMSAccess() {
      updateStatus('üîÑ Testing CMS configuration access...', 'info');
      
      try {
        const response = await fetch('/admin/config.yml');
        if (response.ok) {
          const configText = await response.text();
          updateStatus('‚úÖ Configuration file loaded successfully! CMS should work after authentication.', 'success');
        } else {
          updateStatus(`‚ùå Cannot access config.yml (Status: ${response.status}). Check file deployment.`, 'error');
        }
      } catch (error) {
        updateStatus(`‚ùå Error accessing config.yml: ${error.message}`, 'error');
      }
    }
    
    // Check if Netlify Identity is available
    if (window.netlifyIdentity) {
      updateStatus('üîÑ Initializing authentication system...', 'info');
      
      window.netlifyIdentity.on("init", user => {
        if (user) {
          updateStatus('‚úÖ You are logged in! Testing CMS access...', 'success');
          // Test CMS access after login
          setTimeout(testCMSAccess, 1000);
        } else {
          updateStatus('üëã Please log in to access the content management system.', 'info');
        }
      });
      
      window.netlifyIdentity.on("login", user => {
        updateStatus('‚úÖ Login successful! Loading CMS...', 'success');
        setTimeout(() => {
          window.location.reload();
        }, 2000);
      });
      
      window.netlifyIdentity.on("logout", () => {
        updateStatus('üëã You have been logged out.', 'info');
      });
      
      window.netlifyIdentity.on("error", err => {
        console.error('Identity error:', err);
        
        if (err.message && err.message.includes('Email not confirmed')) {
          updateStatus(`‚ùå Email Confirmation Issue: Follow the steps above to create a user with confirmed email.`, 'error');
        } else if (err.message && err.message.includes('Invalid email or password')) {
          updateStatus(`‚ùå Login Failed: Please check your credentials or create a new user account.`, 'error');
        } else if (err.message && err.message.includes('Failed to fetch')) {
          updateStatus(`‚ùå Network Error: Check your internet connection and try again.`, 'error');
        } else {
          updateStatus(`‚ùå Error: ${err.message || 'Authentication failed'}`, 'error');
        }
      });
      
      // Initialize the widget
      window.netlifyIdentity.init({
        APIUrl: "https://neon-meerkat-c50769.netlify.app/.netlify/identity"
      });
      
    } else {
      updateStatus('‚ùå Netlify Identity is not available. Please check your configuration.', 'error');
    }
    
    // Handle invite token from URL
    const urlParams = new URLSearchParams(window.location.hash.substring(1));
    const inviteToken = urlParams.get('invite_token');
    
    if (inviteToken) {
      updateStatus('üîë Processing invitation token...', 'info');
      
      if (window.netlifyIdentity) {
        window.netlifyIdentity.acceptInvite(inviteToken)
          .then(() => {
            updateStatus('‚úÖ Invitation accepted! Please set your password.', 'success');
          })
          .catch(err => {
            console.error('Invite error:', err);
            updateStatus(`‚ùå Error processing invitation: ${err.message}. Try the manual user creation method above.`, 'error');
          });
      }
    }
    
    // Auto-test configuration on page load
    setTimeout(testCMSAccess, 2000);
  </script>
</body>
</html>