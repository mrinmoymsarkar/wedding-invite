<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Wedding Content Manager</title>
  <link rel="icon" type="image/png" href="https://1fimd9lwq61lrowk.public.blob.vercel-storage.com/wediing-icon-MWGi3zHWRSwveW4CaK9EM7s57pDP54.png" />
  
  <!-- Netlify Identity Widget -->
  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
  
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      margin: 0;
      padding: 20px;
      background: linear-gradient(135deg, #FFF8DC 0%, #FFFFF0 100%);
      min-height: 100vh;
    }
    
    .setup-container {
      max-width: 700px;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      padding: 30px;
      box-shadow: 0 10px 40px rgba(220, 20, 60, 0.15);
      text-align: center;
    }
    
    .logo {
      width: 60px;
      height: 60px;
      margin: 0 auto 20px;
    }
    
    .title {
      color: #8B0000;
      font-size: 28px;
      font-weight: 600;
      margin-bottom: 10px;
    }
    
    .subtitle {
      color: #666;
      font-size: 16px;
      margin-bottom: 30px;
    }
    
    .status {
      padding: 15px;
      border-radius: 8px;
      margin: 20px 0;
      text-align: left;
    }
    
    .info { background: #d1ecf1; border: 1px solid #bee5eb; color: #0c5460; }
    .warning { background: #fff3cd; border: 1px solid #ffeaa7; color: #856404; }
    .error { background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
    .success { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
    
    .button {
      display: inline-block;
      padding: 12px 24px;
      background: linear-gradient(135deg, #DC143C, #8B0000);
      color: white;
      text-decoration: none;
      border-radius: 8px;
      margin: 10px;
      font-weight: 500;
      transition: transform 0.2s;
      border: none;
      cursor: pointer;
    }
    
    .button:hover {
      transform: translateY(-2px);
    }
    
    .button.secondary {
      background: linear-gradient(135deg, #FFD700, #FFC107);
      color: #333;
    }
    
    .button.success {
      background: linear-gradient(135deg, #28a745, #20c997);
      color: white;
    }
    
    .steps {
      text-align: left;
      margin: 30px 0;
    }
    
    .step {
      padding: 15px;
      margin: 10px 0;
      background: #f8f9fa;
      border-left: 4px solid #DC143C;
      border-radius: 0 8px 8px 0;
    }
    
    .step h4 {
      margin: 0 0 10px 0;
      color: #8B0000;
    }
    
    .code {
      background: #f1f3f4;
      padding: 2px 6px;
      border-radius: 4px;
      font-family: 'Monaco', 'Consolas', monospace;
      font-size: 14px;
    }
    
    #netlify-identity-widget {
      margin: 20px 0;
    }
    
    .fix-section {
      background: #e7f3ff;
      border: 2px solid #007bff;
      border-radius: 10px;
      padding: 20px;
      margin: 20px 0;
    }
    
    .fix-section h3 {
      color: #004085;
      margin-top: 0;
    }
    
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #DC143C;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .hidden {
      display: none;
    }
  </style>
</head>
<body>
  <div class="setup-container">
    <img src="https://1fimd9lwq61lrowk.public.blob.vercel-storage.com/wediing-icon-MWGi3zHWRSwveW4CaK9EM7s57pDP54.png" alt="Wedding Icon" class="logo" />
    
    <h1 class="title">Wedding Content Manager</h1>
    <p class="subtitle">Manage your wedding website content easily</p>
    
    <div id="identity-status"></div>
    
    <!-- Fix for Invite Token Loop -->
    <div class="fix-section">
      <h3>üîß Fix: Invite Token Loop Issue</h3>
      <p><strong>Problem:</strong> Getting stuck in a loop after using access token to signup</p>
      <p><strong>Solution:</strong> We'll bypass the invite system and create a direct user account.</p>
      
      <div class="steps">
        <div class="step">
          <h4>Step 1: Clear Browser Data</h4>
          <p>First, let's clear any stuck authentication data:</p>
          <button onclick="clearAuthData()" class="button secondary">
            Clear Authentication Data
          </button>
          <p><small>This will clear any stuck tokens or session data.</small></p>
        </div>
        
        <div class="step">
          <h4>Step 2: Enable Git Gateway</h4>
          <p>Go to Netlify and enable Git Gateway (this bypasses the invite system):</p>
          <ol>
            <li>Open <a href="https://app.netlify.com/sites/neon-meerkat-c50769/settings/identity" target="_blank">Netlify Identity Settings</a></li>
            <li>Scroll down to <strong>"Services"</strong> section</li>
            <li>Click <strong>"Enable Git Gateway"</strong></li>
            <li>Save the settings</li>
          </ol>
        </div>
        
        <div class="step">
          <h4>Step 3: Create User Directly (No Invite)</h4>
          <p>Create a user account without using invites:</p>
          <ol>
            <li>Go to <a href="https://app.netlify.com/sites/neon-meerkat-c50769/identity" target="_blank">Netlify Identity Users</a></li>
            <li>Click <strong>"Add user"</strong> (NOT "Invite users")</li>
            <li>Fill in:
              <ul>
                <li>Email: Your email address</li>
                <li>Password: Choose a secure password</li>
                <li><strong>‚úÖ Check "Email confirmed"</strong> (IMPORTANT!)</li>
              </ul>
            </li>
            <li>Click "Add user"</li>
          </ol>
        </div>
        
        <div class="step">
          <h4>Step 4: Test Direct Login</h4>
          <p>Now try logging in with your new credentials:</p>
          <button onclick="testDirectLogin()" class="button success">
            Test Login
          </button>
        </div>
      </div>
      
      <div class="warning status">
        <strong>‚ö†Ô∏è Important:</strong>
        <br>‚Ä¢ Don't use invite links anymore
        <br>‚Ä¢ Always create users directly in Netlify dashboard
        <br>‚Ä¢ Make sure "Email confirmed" is checked
        <br>‚Ä¢ Clear browser data if you get stuck
      </div>
    </div>
    
    <div id="netlify-identity-widget"></div>
    
    <div style="margin-top: 30px;">
      <button onclick="testCMSAccess()" class="button">
        Test CMS Configuration
      </button>
      <a href="https://app.netlify.com/sites/neon-meerkat-c50769/settings/identity" target="_blank" class="button secondary">
        Open Netlify Settings
      </a>
    </div>
    
    <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #eee; color: #666; font-size: 14px;">
      <p><strong>Alternative:</strong> If the CMS still doesn't work, you can edit files directly in the <span class="code">src/config/</span> directory.</p>
    </div>
  </div>

  <!-- Include the script that builds the page and powers Decap CMS -->
  <script src="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js"></script>
  
  <!-- Enhanced Netlify Identity integration -->
  <script>
    const statusDiv = document.getElementById('identity-status');
    
    function updateStatus(message, type = 'info') {
      statusDiv.innerHTML = `<div class="${type} status">${message}</div>`;
    }
    
    // Clear authentication data
    function clearAuthData() {
      // Clear localStorage
      localStorage.removeItem('gotrue.user');
      localStorage.removeItem('netlify-cms-user');
      
      // Clear sessionStorage
      sessionStorage.clear();
      
      // Clear cookies
      document.cookie.split(";").forEach(function(c) { 
        document.cookie = c.replace(/^ +/, "").replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/"); 
      });
      
      updateStatus('‚úÖ Authentication data cleared! Now try the steps above.', 'success');
      
      // Remove any invite token from URL
      if (window.location.hash.includes('invite_token')) {
        window.location.hash = '';
        window.location.reload();
      }
    }
    
    // Test direct login
    function testDirectLogin() {
      if (window.netlifyIdentity) {
        updateStatus('üîÑ Opening login dialog...', 'info');
        window.netlifyIdentity.open();
      } else {
        updateStatus('‚ùå Netlify Identity not available', 'error');
      }
    }
    
    // Test CMS configuration access
    async function testCMSAccess() {
      updateStatus('üîÑ Testing CMS configuration access...', 'info');
      
      try {
        const response = await fetch('/admin/config.yml');
        if (response.ok) {
          const configText = await response.text();
          updateStatus('‚úÖ Configuration file loaded successfully! CMS should work after authentication.', 'success');
        } else {
          updateStatus(`‚ùå Cannot access config.yml (Status: ${response.status}). Check file deployment.`, 'error');
        }
      } catch (error) {
        updateStatus(`‚ùå Error accessing config.yml: ${error.message}`, 'error');
      }
    }
    
    // Check if Netlify Identity is available
    if (window.netlifyIdentity) {
      updateStatus('üîÑ Initializing authentication system...', 'info');
      
      // Clear any existing invite token issues
      const urlParams = new URLSearchParams(window.location.hash.substring(1));
      if (urlParams.get('invite_token')) {
        updateStatus('‚ö†Ô∏è Invite token detected. Clearing to prevent loop...', 'warning');
        window.location.hash = '';
        clearAuthData();
      }
      
      window.netlifyIdentity.on("init", user => {
        if (user) {
          updateStatus('‚úÖ You are logged in! Loading CMS...', 'success');
          // Hide the setup instructions and show CMS
          setTimeout(() => {
            document.querySelector('.setup-container').style.display = 'none';
            // Initialize CMS
            if (window.CMS) {
              window.CMS.init();
            }
          }, 2000);
        } else {
          updateStatus('üëã Please log in using the steps above. Do NOT use invite links.', 'info');
        }
      });
      
      window.netlifyIdentity.on("login", user => {
        updateStatus('‚úÖ Login successful! Loading CMS...', 'success');
        setTimeout(() => {
          window.location.reload();
        }, 2000);
      });
      
      window.netlifyIdentity.on("logout", () => {
        updateStatus('üëã You have been logged out.', 'info');
      });
      
      window.netlifyIdentity.on("error", err => {
        console.error('Identity error:', err);
        
        if (err.message && err.message.includes('Email not confirmed')) {
          updateStatus(`‚ùå Email Confirmation Issue: Create a user directly in Netlify dashboard with "Email confirmed" checked.`, 'error');
        } else if (err.message && err.message.includes('Invalid email or password')) {
          updateStatus(`‚ùå Login Failed: Check your credentials or create a new user account directly in Netlify.`, 'error');
        } else if (err.message && err.message.includes('Failed to fetch')) {
          updateStatus(`‚ùå Network Error: Check your internet connection and try again.`, 'error');
        } else {
          updateStatus(`‚ùå Error: ${err.message || 'Authentication failed'}. Try clearing auth data and creating a direct user account.`, 'error');
        }
      });
      
      // Initialize the widget
      window.netlifyIdentity.init({
        APIUrl: "https://neon-meerkat-c50769.netlify.app/.netlify/identity"
      });
      
    } else {
      updateStatus('‚ùå Netlify Identity is not available. Please check your configuration.', 'error');
    }
    
    // Auto-test configuration on page load
    setTimeout(testCMSAccess, 2000);
  </script>
</body>
</html>